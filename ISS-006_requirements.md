# ISS-006: フィルムエフェクトレイヤーのグループ格納問題

## 課題概要
フィルムエフェクト機能実行時に「フィルムエフェクト」グループは作成されるが、実際に生成されるレイヤー（ハレーション、グレイン、ドリーミーヘイズなど）がそのグループ内に配置されていない問題の修正。

## 現状分析

### 問題の詳細
1. **グループ作成タイミング**: Film Effectsグループが最初に作成される（331-336行）
2. **レイヤー作成順序**: 新しいレイヤーは常にグループより上位に作成される
3. **移動処理の実行**: `moveLayerToGroup()`関数は呼ばれているが、エラーで失敗している
4. **エラーハンドリング**: エラーが「無視」されるため問題が表面化しない

### 影響を受ける機能
- **ハレーション効果**: 2つのレイヤー（Halation Base, Halation Color）
- **Dreamy Haze効果**: 最大3つのレイヤー（Blur Screen, Tone Curve Adjust, Gradient Map Adjust）
- **暗部グレイン効果**: 1つのレイヤー（Dark Grain）

### 技術的問題点
1. **moveLayerToGroup()関数の不具合**: main.js:463-489行
2. **レイヤー作成順序**: Photoshopの仕様上、新規レイヤーは最上位に作成される
3. **グループ参照の問題**: グループレイヤーのIDやインデックスに関する問題

## 要件定義

### 機能要件
- **FR-1**: フィルムエフェクト実行時、すべてのエフェクトレイヤーが「Film Effects」グループ内に配置される
- **FR-2**: レイヤーの階層構造が適切に維持される（クリッピングマスクなどの関係性を保持）
- **FR-3**: エラーが発生した場合でも、ユーザーに分かりやすいメッセージを表示する

### 非機能要件
- **NFR-1**: 既存の機能に影響を与えない
- **NFR-2**: レイヤー移動処理のパフォーマンスが許容範囲内である
- **NFR-3**: エラーハンドリングが適切に行われる

### 制約条件
- **CON-1**: Adobe UXP APIの制限に従う
- **CON-2**: Photoshopのレイヤー階層ルールに準拠する
- **CON-3**: 既存のUIとワークフローを維持する

## 修正計画

### Phase 1: 問題調査と診断強化
1. **moveLayerToGroup()関数のデバッグ強化**
   - エラーの詳細ログ出力
   - グループレイヤーの状態確認
   - レイヤー選択の成功/失敗確認

2. **レイヤー作成順序の確認**
   - 各エフェクト実行後のレイヤー構造ログ出力
   - グループとレイヤーの相対位置確認

### Phase 2: 修正方法の選択
以下の3つのアプローチから最適解を選択：

#### アプローチA: moveLayerToGroup()関数の修正
- **pros**: 既存の設計思想を維持
- **cons**: Adobe UXP APIの制限で解決困難な可能性
- **実装**: レイヤー移動APIの調査と修正

#### アプローチB: レイヤー作成順序の変更  
- **pros**: 根本的解決、シンプルな実装
- **cons**: 既存コードの大幅変更が必要
- **実装**: グループを最後に作成し、既存レイヤーをまとめて移動

#### アプローチC: ハイブリッドアプローチ
- **pros**: 確実性が高い、段階的実装可能
- **cons**: 複雑性の増加
- **実装**: レイヤー作成時に一時的にグループを作成し、後で再構築

### Phase 3: 実装とテスト
1. **選択したアプローチの実装**
2. **単体テスト**: 各エフェクト単体でのグループ配置確認
3. **統合テスト**: 複数エフェクト同時実行時の動作確認
4. **エラーハンドリングテスト**: 異常ケースでの動作確認

### Phase 4: 品質保証
1. **パフォーマンステスト**: レイヤー移動処理の速度測定
2. **ユーザビリティテスト**: UI応答性とエラーメッセージの確認
3. **回帰テスト**: 既存機能への影響確認

## 成功基準

### 必須基準
- [ ] すべてのフィルムエフェクトレイヤーが「Film Effects」グループ内に配置される
- [ ] クリッピングマスクなどの関係性が正しく維持される
- [ ] エラーが発生しない、または適切にハンドリングされる

### 望ましい基準
- [ ] レイヤー移動処理が2秒以内に完了する
- [ ] エラーメッセージがユーザーフレンドリーである
- [ ] デバッグログが開発者にとって有用である

## リスク分析

### 高リスク
- **R-1**: Adobe UXP APIの制限によりレイヤー移動が不可能
  - 対策: アプローチBまたはCに切り替え

### 中リスク  
- **R-2**: レイヤー階層の変更により既存機能に影響
  - 対策: 十分な回帰テストの実施

### 低リスク
- **R-3**: パフォーマンスの軽微な劣化
  - 対策: 最適化の実施

## 次のアクション

1. **Phase 1の実行**: moveLayerToGroup()関数のデバッグ強化
2. **問題の根本原因特定**: 詳細ログによる問題箇所の絞り込み
3. **修正アプローチの決定**: 調査結果に基づく最適解の選択
4. **実装開始**: 選択したアプローチでの修正作業開始

---

*作成日: 2025-06-08*
*更新日: 2025-06-08*
*担当者: nob*